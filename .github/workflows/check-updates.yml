name: Check for Runtime Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9am UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get supported Lambda Python versions
        id: python
        run: |
          # Get versions from AWS docs, filter to only supported (3.10+)
          VERSIONS=$(curl -s "https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html" | \
            grep -oP 'python3\.\d+' | sort -V | uniq | sed 's/python//' | \
            awk -F. '$2 >= 10' | tr '\n' ' ' | xargs)
          [ -z "$VERSIONS" ] && VERSIONS="3.10 3.11 3.12 3.13 3.14"
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

      - name: Get latest MSODBC version
        id: msodbc
        run: |
          LATEST=$(curl -s "https://packages.microsoft.com/config/rhel/8/prod.repo" | \
            grep -oP 'msodbcsql\d+' | grep -oP '\d+' | sort -rn | head -1)
          [ -z "$LATEST" ] && LATEST="18"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Get latest unixODBC version
        id: unixodbc
        run: |
          LATEST=$(curl -s "http://www.unixodbc.org/download.html" | \
            grep -oP 'unixODBC-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -1)
          [ -z "$LATEST" ] && LATEST="2.3.14"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Get current versions from config
        id: current
        run: |
          AL2=$(jq -r '.python.al2 | join(" ")' versions.json)
          AL2023=$(jq -r '.python.al2023 | join(" ")' versions.json)
          MSODBC=$(jq -r '.msodbc | join(" ")' versions.json)
          UNIXODBC=$(jq -r '.unixodbc' versions.json)
          echo "al2=$AL2" >> $GITHUB_OUTPUT
          echo "al2023=$AL2023" >> $GITHUB_OUTPUT
          echo "msodbc=$MSODBC" >> $GITHUB_OUTPUT
          echo "unixodbc=$UNIXODBC" >> $GITHUB_OUTPUT

      - name: Determine updates needed
        id: update
        run: |
          AVAILABLE="${{ steps.python.outputs.versions }}"
          CURRENT_AL2="${{ steps.current.outputs.al2 }}"
          CURRENT_AL2023="${{ steps.current.outputs.al2023 }}"
          CURRENT_MSODBC="${{ steps.current.outputs.msodbc }}"
          CURRENT_UNIXODBC="${{ steps.current.outputs.unixodbc }}"
          NEW_MSODBC="${{ steps.msodbc.outputs.version }}"
          NEW_UNIXODBC="${{ steps.unixodbc.outputs.version }}"

          # Split Python versions: AL2 (<=3.11), AL2023 (>=3.12)
          AL2_NEW="" AL2023_NEW=""
          for v in $AVAILABLE; do
            MINOR=$(echo $v | cut -d. -f2)
            if [ "$MINOR" -le 11 ]; then
              AL2_NEW="${AL2_NEW:+$AL2_NEW }$v"
            else
              AL2023_NEW="${AL2023_NEW:+$AL2023_NEW }$v"
            fi
          done

          echo "al2_new=$AL2_NEW" >> $GITHUB_OUTPUT
          echo "al2023_new=$AL2023_NEW" >> $GITHUB_OUTPUT
          echo "msodbc_new=$NEW_MSODBC" >> $GITHUB_OUTPUT
          echo "unixodbc_new=$NEW_UNIXODBC" >> $GITHUB_OUTPUT

          # Check if any update needed
          NEEDS_UPDATE=false
          PYTHON_CHANGED=false
          MSODBC_CHANGED=false
          UNIXODBC_CHANGED=false

          if [ "$AL2_NEW" != "$CURRENT_AL2" ] || [ "$AL2023_NEW" != "$CURRENT_AL2023" ]; then
            NEEDS_UPDATE=true
            PYTHON_CHANGED=true
          fi

          # Check if MSODBC major version is new (not already in the list)
          if ! echo "$CURRENT_MSODBC" | grep -qw "$NEW_MSODBC"; then
            NEEDS_UPDATE=true
            MSODBC_CHANGED=true
          fi

          if [ "$NEW_UNIXODBC" != "$CURRENT_UNIXODBC" ]; then
            NEEDS_UPDATE=true
            UNIXODBC_CHANGED=true
          fi

          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          echo "python_changed=$PYTHON_CHANGED" >> $GITHUB_OUTPUT
          echo "msodbc_changed=$MSODBC_CHANGED" >> $GITHUB_OUTPUT
          echo "unixodbc_changed=$UNIXODBC_CHANGED" >> $GITHUB_OUTPUT

      - name: Update versions.json
        if: steps.update.outputs.needs_update == 'true'
        run: |
          AL2="${{ steps.update.outputs.al2_new }}"
          AL2023="${{ steps.update.outputs.al2023_new }}"
          NEW_MSODBC="${{ steps.update.outputs.msodbc_new }}"
          NEW_UNIXODBC="${{ steps.update.outputs.unixodbc_new }}"

          # Convert space-separated versions to JSON arrays
          AL2_JSON=$(echo "$AL2" | tr ' ' '\n' | jq -R . | jq -s .)
          AL2023_JSON=$(echo "$AL2023" | tr ' ' '\n' | jq -R . | jq -s .)

          # Get current MSODBC array and add new version if needed
          CURRENT_MSODBC_JSON=$(jq '.msodbc' versions.json)
          if [ "${{ steps.update.outputs.msodbc_changed }}" == "true" ]; then
            MSODBC_JSON=$(echo "$CURRENT_MSODBC_JSON" | jq --arg v "$NEW_MSODBC" '. + [$v] | unique | sort')
          else
            MSODBC_JSON="$CURRENT_MSODBC_JSON"
          fi

          # Build new versions.json
          jq -n \
            --argjson al2 "$AL2_JSON" \
            --argjson al2023 "$AL2023_JSON" \
            --argjson msodbc "$MSODBC_JSON" \
            --arg unixodbc "$NEW_UNIXODBC" \
            '{
              python: {
                al2: $al2,
                al2023: $al2023
              },
              msodbc: $msodbc,
              unixodbc: $unixodbc
            }' > versions.json

          cat versions.json

      - name: Create Pull Request
        if: steps.update.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="chore/update-runtimes-$(date +%Y%m%d)"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Build change summary
          CHANGES=""
          if [ "${{ steps.update.outputs.python_changed }}" == "true" ]; then
            CHANGES="${CHANGES}- Python (AL2): ${{ steps.update.outputs.al2_new }}\n"
            CHANGES="${CHANGES}- Python (AL2023): ${{ steps.update.outputs.al2023_new }}\n"
          fi
          if [ "${{ steps.update.outputs.msodbc_changed }}" == "true" ]; then
            CHANGES="${CHANGES}- MSODBC: added ${{ steps.update.outputs.msodbc_new }}\n"
          fi
          if [ "${{ steps.update.outputs.unixodbc_changed }}" == "true" ]; then
            CHANGES="${CHANGES}- unixODBC: ${{ steps.update.outputs.unixodbc_new }}\n"
          fi

          git checkout -b "$BRANCH"
          git add versions.json
          git commit -m "chore(deps): update runtime versions

          $(echo -e "$CHANGES")"

          git push origin "$BRANCH"

          gh pr create \
            --title "chore(deps): update runtime versions" \
            --body "## Summary

          Automated update of runtime versions:

          $(echo -e "$CHANGES")

          This PR was automatically created by the Check for Runtime Updates workflow." \
            --base main \
            --head "$BRANCH"
